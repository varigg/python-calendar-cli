# Implementation Plan: Layer Separation Enforcement

**Branch**: `006-layer-separation` | **Date**: 2026-01-17 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `specs/006-layer-separation/spec.md`

**Note**: This plan is generated by `/speckit.plan` command workflow. It outlines technical architecture and research needs before detailed task planning.

## Summary

Remove UI layer dependencies from infrastructure and config layers to enforce clean architectural boundaries. Currently, `gtool.infrastructure` imports `click` and raises CLI-specific errors, while `gtool.config` uses `click` prompts and raises `click.UsageError`. This refactoring introduces infrastructure-level exceptions, moves interactive prompting to the CLI layer, and establishes clear exception mapping patterns.

**Primary Requirements**:

- Remove `click` imports and CLI error types from infrastructure layer
- Introduce infrastructure-level exceptions (`AuthError`, `ServiceError`)
- Move interactive prompting from config to CLI layer
- Replace `click.UsageError` with domain exceptions in config validation
- Add exception translation layer in CLI to maintain user experience
- Ensure 100% backward compatibility for CLI users

**Technical Approach**:

1. Create `src/gtool/infrastructure/exceptions.py` ‚Äî define infrastructure exceptions
2. Update `src/gtool/infrastructure/auth.py` ‚Äî remove `click`, use infrastructure exceptions
3. Update `src/gtool/infrastructure/retry.py` ‚Äî use infrastructure exceptions instead of CLI errors
4. Update `src/gtool/config/settings.py` ‚Äî remove `click`, define config exceptions, move prompting logic to CLI
5. Update `src/gtool/cli/main.py` ‚Äî add exception translation and interactive prompting
6. Update all tests to expect new exception types

## Technical Context

**Language/Version**: Python 3.12+ (from pyproject.toml)
**Primary Dependencies**: google-api-python-client, google-auth, google-auth-oauthlib, click (CLI layer only)
**Storage**: Configuration files in `~/.config/gtool/` (file-based, no database)
**Testing**: pytest (existing test suite in `tests/`)
**Target Platform**: Linux/macOS/Windows CLI application
**Project Type**: Single Python CLI package with layered architecture
**Performance Goals**: No performance impact; purely architectural refactoring
**Constraints**:

- 100% backward compatibility for CLI users
- No changes to configuration file format
- All existing tests must pass
- Infrastructure must be importable without `click`
  **Scale/Scope**: Single-user CLI; enabling future expansion to GUI/API interfaces

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

### Principle I: Separation of Concerns (NON-NEGOTIABLE) ‚úÖ PASS

**Requirement**: CLI logic, business logic, formatting, error handling, and external service interactions MUST be isolated in separate modules.

**Status**: ‚úÖ PASS ‚Äî Refactoring ENFORCES this principle by:

- Removing UI dependencies from infrastructure layer (`click` imports eliminated)
- Removing UI dependencies from config layer (interactive prompts moved to CLI)
- Introducing clear exception boundaries (infrastructure ‚Üí CLI translation)
- Maintaining separation: infrastructure (auth/retry), config (data/validation), CLI (user interaction)

**No violations**: This refactoring FIXES violations of Principle I identified in analysis.md.

---

### Principle II: Test-First Development (NON-NEGOTIABLE) ‚úÖ PASS

**Requirement**: Tests MUST be written before implementation (TDD mandatory). External services MUST use mocks.

**Status**: ‚úÖ PASS ‚Äî Design supports TDD:

- New infrastructure exceptions will have test coverage
- Config validation tests updated to expect domain exceptions
- CLI exception translation tests added
- All existing test patterns remain valid (mocks already in place)
- Tests can be written first for each exception type

**No violations**: TDD workflow fully supported.

---

### Principle III: Type Safety & Documentation (MUST) ‚úÖ PASS

**Requirement**: All function/method signatures MUST include type hints and docstrings.

**Status**: ‚úÖ PASS ‚Äî Design enforces this:

- New exception classes will have docstrings explaining when they're raised
- Updated functions maintain existing type hints
- Exception translation functions will be fully typed
- All public APIs retain documentation

**No violations**: Full type safety and documentation maintained.

---

### Principle IV: CLI-First Design (MUST) ‚úÖ PASS

**Requirement**: Every feature MUST be accessible via CLI using click framework. Support JSON + human-readable formats.

**Status**: ‚úÖ PASS ‚Äî Design preserves CLI:

- CLI layer retains all `click` functionality
- User experience remains identical (backward compatibility)
- CLI remains the primary interface
- Infrastructure/config become CLI-independent (enabling future expansion)

**No violations**: CLI functionality preserved; other layers become reusable.

---

### Principle V: PEP8 & Best Practices (MUST) ‚úÖ PASS

**Requirement**: Code MUST follow PEP8. Imports MUST be absolute (no relative imports). Circular imports forbidden. Secrets NOT committed.

**Status**: ‚úÖ PASS ‚Äî Design conforms:

- All imports remain absolute (e.g., `from gtool.infrastructure.exceptions import AuthError`)
- No circular dependencies: infrastructure ‚Üí exceptions; config ‚Üí exceptions; CLI ‚Üí both
- No credential handling changes (stays in config)
- PEP8 formatting maintained throughout

**No violations**: No deviations from project standards.

---

### Constitution Result

**‚úÖ PASS ‚Äî ALL 5 PRINCIPLES SATISFIED**

No violations or exceptions needed. Refactoring FIXES existing Principle I violations identified in analysis.md.

## Project Structure

### Documentation (this feature)

```text
specs/006-layer-separation/
‚îú‚îÄ‚îÄ spec.md              # Feature specification ‚úÖ COMPLETE
‚îú‚îÄ‚îÄ plan.md              # This file (implementation plan outline)
‚îú‚îÄ‚îÄ checklists/
‚îÇ   ‚îî‚îÄ‚îÄ requirements.md  # Spec quality checklist ‚úÖ COMPLETE
‚îî‚îÄ‚îÄ tasks.md             # Phase 2 output (implementation tasks) - TO BE GENERATED
```

### Source Code (repository root)

Current Structure (Python single-project layout):

```text
src/gtool/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ cli/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ errors.py        # CLI-specific exceptions (AuthenticationError, CLIError)
‚îÇ   ‚îú‚îÄ‚îÄ formatters.py    # Output formatting
‚îÇ   ‚îî‚îÄ‚îÄ main.py          # Click commands ‚ö†Ô∏è WILL BE MODIFIED (add exception translation)
‚îú‚îÄ‚îÄ clients/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ calendar.py      # Calendar API client
‚îÇ   ‚îî‚îÄ‚îÄ gmail.py         # Gmail API client
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ settings.py      # Configuration ‚ö†Ô∏è WILL BE MODIFIED (remove click, add exceptions)
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ models.py        # Domain models
‚îÇ   ‚îî‚îÄ‚îÄ scheduler.py     # Scheduling logic
‚îú‚îÄ‚îÄ infrastructure/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ auth.py          # Authentication ‚ö†Ô∏è WILL BE MODIFIED (remove click)
‚îÇ   ‚îú‚îÄ‚îÄ error_categorizer.py
‚îÇ   ‚îú‚îÄ‚îÄ exceptions.py    # üÜï NEW FILE (infrastructure exceptions)
‚îÇ   ‚îú‚îÄ‚îÄ retry.py         # Retry policy ‚ö†Ô∏è WILL BE MODIFIED (use infra exceptions)
‚îÇ   ‚îî‚îÄ‚îÄ service_factory.py
‚îî‚îÄ‚îÄ utils/
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îî‚îÄ‚îÄ datetime.py

tests/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ conftest.py
‚îú‚îÄ‚îÄ test_cli.py          # ‚ö†Ô∏è WILL BE MODIFIED (test exception translation)
‚îú‚îÄ‚îÄ test_config.py       # ‚ö†Ô∏è WILL BE MODIFIED (expect domain exceptions)
‚îú‚îÄ‚îÄ test_google_auth.py  # ‚ö†Ô∏è WILL BE MODIFIED (expect infra exceptions)
‚îú‚îÄ‚îÄ test_retry_policy.py # ‚ö†Ô∏è WILL BE MODIFIED (expect infra exceptions)
‚îî‚îÄ‚îÄ [other test files]   # May need minor updates if they depend on exception types
```

**Structure Decision**: Single Python project structure maintained. This is a refactoring effort that modifies existing modules to enforce layer boundaries, not a restructure. Key changes:

- **NEW**: `src/gtool/infrastructure/exceptions.py` ‚Äî Infrastructure exception types
- **MODIFIED**: Auth, retry, config, CLI modules to use proper exception types
- **NO CHANGES**: Client, core, and utils layers (already properly separated)

## Files to Create

### 1. Infrastructure Exceptions Module

**File**: `src/gtool/infrastructure/exceptions.py`

**Purpose**: Define infrastructure-level exceptions that don't depend on UI layer.

**Content**:

- `AuthError` ‚Äî Authentication/authorization failures
- `ServiceError` ‚Äî Google API service errors
- `ConfigError` ‚Äî Configuration errors (base for config layer)
- Proper exception hierarchy with helpful messages

### 2. Config Exceptions

**Location**: `src/gtool/config/settings.py` (within existing file)

**Purpose**: Define config-specific domain exceptions.

**Content**:

- `ConfigValidationError` ‚Äî Configuration validation failures (inherits from `ConfigError`)
- Used instead of `click.UsageError` for validation failures

## Files to Modify

### 1. Infrastructure Auth Module

**File**: `src/gtool/infrastructure/auth.py`

**Changes**:

- Remove `import click`
- Remove CLI error references in docstrings
- Use `AuthError` instead of CLI exceptions
- Keep all authentication logic intact

### 2. Infrastructure Retry Module

**File**: `src/gtool/infrastructure/retry.py`

**Changes**:

- Remove `from gtool.cli.errors import AuthenticationError`
- Import `AuthError` from `gtool.infrastructure.exceptions`
- Wrap Google auth errors in `AuthError` instead of `AuthenticationError`
- Update error messages to be CLI-agnostic

### 3. Config Settings Module

**File**: `src/gtool/config/settings.py`

**Changes**:

- Remove `import click`
- Remove `Config.prompt()` method (logic moves to CLI)
- Replace `raise click.UsageError` with `raise ConfigValidationError`
- Add config exception classes
- Keep all validation logic intact

### 4. CLI Main Module

**File**: `src/gtool/cli/main.py`

**Changes**:

- Add exception handlers to catch infrastructure exceptions
- Map `AuthError` ‚Üí `AuthenticationError` (CLI)
- Map `ServiceError` ‚Üí `CLIError` (CLI)
- Map `ConfigValidationError` ‚Üí `click.UsageError` (CLI)
- Add interactive config prompting function (moved from Config.prompt())
- Update `config` command to use new prompting

### 5. Test Updates

**Files**: Multiple test files

**Changes**:

- Update tests expecting `click.UsageError` from config to expect `ConfigValidationError`
- Update tests expecting CLI errors from infrastructure to expect infrastructure exceptions
- Add tests for exception translation in CLI layer
- Add tests for infrastructure independence (no `click` import required)

## Implementation Strategy

### Phase 0: Setup

1. Create infrastructure exceptions module
2. Define exception hierarchy and base classes

### Phase 1: Infrastructure Layer (Priority P1)

1. Update `auth.py` ‚Äî Remove `click`, use `AuthError`
2. Update `retry.py` ‚Äî Use infrastructure exceptions
3. Test infrastructure modules independently (no CLI required)

### Phase 2: Config Layer (Priority P2)

1. Add config exceptions to `settings.py`
2. Replace `click.UsageError` with domain exceptions
3. Remove `Config.prompt()` method
4. Test config validation without `click`

### Phase 3: CLI Layer (Priority P3)

1. Add exception translation in `main.py`
2. Implement interactive config prompting in CLI
3. Map all infrastructure exceptions to CLI errors
4. Test end-to-end user experience

### Phase 4: Integration & Validation

1. Run full test suite
2. Verify no `click` in infrastructure/config imports
3. Verify backward compatibility
4. Create non-CLI reuse demonstration
5. Add high-value integration tests (factory ‚Üí auth ‚Üí config flow)

## Testing Strategy

### Unit Tests (Existing)

- Infrastructure exceptions raised correctly
- Config validation logic works
- CLI exception translation functions

### Integration Tests (High-Value Only)

**Purpose**: Catch bugs that mocks hide (e.g., ServiceFactory credentials bug)

**DO Test** (mock only external Google API):

- Factory ‚Üí GoogleAuth ‚Üí Config initialization flow
- Exception propagation through layers
- Scope validation during auth initialization
- Missing credentials file handling

**DON'T Over-Test**:

- Output formatting variations (low value)
- Every edge case combination (diminishing returns)
- Behavior already covered by unit tests

**Example High-Value Test**:

```python
def test_infrastructure_auth_with_missing_credentials():
    """Verify AuthError raised when credentials file missing."""
    config = Config()
    config.data["CREDENTIALS_FILE"] = "/nonexistent/path"

    with pytest.raises(AuthError, match="credentials"):
        auth = GoogleAuth(config)
        auth.get_credentials()
```

## Success Criteria Mapping

| Success Criterion                               | Implementation Evidence                                           |
| ----------------------------------------------- | ----------------------------------------------------------------- |
| SC-001: 0 click imports in infrastructure       | Grep/import analysis shows no `click` in `gtool.infrastructure.*` |
| SC-002: 100% config test coverage without click | Config tests pass without mocking `click`                         |
| SC-003: 100% existing CLI tests pass            | Full test suite passes without modification to test expectations  |
| SC-004: Non-CLI reuse demonstration             | Example script imports and uses infrastructure without CLI        |
| SC-005: Clear exception flow documentation      | Exception hierarchy documented in exceptions.py and README        |
| SC-006: Integration tests catch real bugs       | Tests verify factory/auth/config without over-mocking             |

## Risks & Mitigations

| Risk                             | Mitigation                                                  |
| -------------------------------- | ----------------------------------------------------------- |
| Breaking existing error handling | Comprehensive test coverage; verify all exception callsites |
| CLI user experience changes      | Maintain exact same error messages and prompts              |
| Test brittleness                 | Update tests to expect domain exceptions, not UI exceptions |
| Incomplete exception mapping     | Trace all error paths from infrastructure ‚Üí CLI             |

## Dependencies

- No external dependencies added
- No breaking changes to `click`, Google API, or other libraries
- Requires review of all error handling paths
- Requires review of all `Config.prompt()` usage

## Out of Scope

- Adding new configuration options
- Changing configuration file format
- Implementing alternative UI layers (GUI/API)
- Adding new infrastructure services
- Performance optimization
- Adding new authentication methods
