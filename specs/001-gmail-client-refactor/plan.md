# Implementation Plan: Gmail Client Integration & Google Auth Refactoring

**Branch**: `001-gmail-client-refactor` | **Date**: 2026-01-15 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `specs/001-gmail-client-refactor/spec.md`

**Note**: This plan is generated by `/speckit.plan` command workflow. It outlines technical architecture and research needs before detailed task planning.

## Summary

Extract Google authentication and credential management logic from `GCalClient` into a dedicated, reusable module that both Calendar and Gmail clients can use. This prevents auth code duplication and establishes a base client pattern that all future Google API integrations will follow. The refactoring maintains 100% backward compatibility with Calendar functionality while enabling clean Gmail integration.

**Primary Requirements**:

- Extract auth into independent module (GoogleAuth)
- Create base client abstraction (GoogleAPIClient) for consistency
- Implement Gmail client following the base pattern
- Extend configuration for multi-scope support
- Maintain all existing Calendar tests/functionality

**Technical Approach**:

1. Create `src/caltool/google_auth.py` — handles OAuth flow, token management, credential refresh
2. Create `src/caltool/google_client.py` — abstract base class with common patterns (retry, error handling, service building)
3. Refactor `GCalClient` to inherit from `GoogleAPIClient`
4. Implement `GMailClient` following same pattern
5. Extend `config.py` for Gmail-specific settings
6. Add CLI commands for Gmail operations

## Technical Context

**Language/Version**: Python 3.12+ (from pyproject.toml)
**Primary Dependencies**: google-api-python-client (>=2.169.0), google-auth (>=2.39.0), google-auth-oauthlib (>=1.2.2)
**Storage**: N/A (credentials stored in ~/.config/caltool/ on disk; no database)
**Testing**: pytest (existing test suite in `tests/`)
**Target Platform**: Linux/macOS/Windows CLI application
**Project Type**: Single Python CLI package with modular architecture
**Performance Goals**: Message retrieval <2 seconds; graceful handling of rate limits
**Constraints**: Maintain 100% backward compatibility; no breaking API changes to Calendar commands
**Scale/Scope**: Single-user CLI; no multi-user or server requirements; supports multiple Google scopes

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

### Principle I: Separation of Concerns (NON-NEGOTIABLE) ✅ PASS

**Requirement**: CLI logic, business logic, formatting, error handling, and external service interactions MUST be isolated in separate modules.

**Status**: ✅ PASS — Refactoring ENFORCES this principle by:

- Extracting `google_auth.py` for auth-only logic
- Creating `google_client.py` base class for common patterns
- Keeping `gcal_client.py` and `gmail_client.py` focused on API-specific methods only
- Preserving separation: `cli.py` (commands), `format.py` (output), `errors.py` (exceptions), `config.py` (settings)

**No violations**: Refactoring improves separation, doesn't degrade it.

---

### Principle II: Test-First Development (NON-NEGOTIABLE) ✅ PASS

**Requirement**: Tests MUST be written before implementation (TDD mandatory). External services MUST use mocks.

**Status**: ✅ PASS — Design supports TDD:

- All new modules (`google_auth.py`, `google_client.py`, `gmail_client.py`) will have corresponding test files
- Google API mocks already exist in test patterns (refactoring extends these)
- Base client abstraction enables mock-friendly dependency injection
- Success Criterion SC-005 requires 80%+ test coverage for new code

**No violations**: This refactoring creates opportunities for better testing through clear module boundaries.

---

### Principle III: Type Safety & Documentation (MUST) ✅ PASS

**Requirement**: All function/method signatures MUST include type hints and docstrings.

**Status**: ✅ PASS — Design enforces this:

- All new functions will have type hints (Python 3.12 features supported)
- All public classes/methods will have docstrings explaining purpose, parameters, return values
- Base client abstraction will define clear type contracts
- Success Criterion SC-004 requires 100% type hints and docstrings for new modules

**No violations**: New code will meet full requirements.

---

### Principle IV: CLI-First Design (MUST) ✅ PASS

**Requirement**: Every feature MUST be accessible via CLI using click framework. Support JSON + human-readable formats.

**Status**: ✅ PASS — Design includes:

- Gmail commands exposed via `caltool gmail` command group (click-based)
- Both human-readable and JSON output formats (per spec)
- Intuitive arguments (e.g., `--limit 10`, `--format json`)
- Help messages for all commands

**No violations**: Refactoring enables CLI expansion.

---

### Principle V: PEP8 & Best Practices (MUST) ✅ PASS

**Requirement**: Code MUST follow PEP8. Imports MUST be absolute (no relative imports). Circular imports forbidden. Secrets NOT committed.

**Status**: ✅ PASS — Design conforms:

- All new modules use absolute imports (e.g., `from caltool.google_auth import GoogleAuth`)
- No circular dependencies: auth → config; config → clients; clients use both
- Credential files stay in `~/.config/caltool/` (not committed)
- PEP8 formatting enforced by ruff (already configured in project)

**No violations**: No deviations from project standards.

---

### Constitution Result

**✅ PASS — ALL 5 PRINCIPLES SATISFIED**

No violations or exceptions needed. Refactoring STRENGTHENS compliance, especially Principle I (Separation of Concerns).

## Project Structure

### Documentation (this feature)

```text
specs/001-gmail-client-refactor/
├── spec.md              # Feature specification ✅ COMPLETE
├── plan.md              # This file (implementation plan outline)
├── research.md          # Phase 0 output (research findings)
├── data-model.md        # Phase 1 output (entity/scope definitions)
├── quickstart.md        # Phase 1 output (developer onboarding)
├── contracts/           # Phase 1 output (API/protocol contracts)
├── checklists/
│   └── requirements.md  # Spec quality checklist ✅ COMPLETE
└── tasks.md             # Phase 2 output (implementation tasks)
```

### Source Code (repository root)

Current Structure (Python single-project layout):

```text
src/caltool/
├── __init__.py
├── cli.py               # CLI commands (click-based)
├── config.py            # Configuration management
├── datetime_utils.py    # Date/time utilities
├── errors.py            # Exception handling
├── format.py            # Output formatting
├── gcal_client.py       # Google Calendar client (to be refactored)
├── scheduler.py         # Scheduling logic
├── google_auth.py       # ✨ NEW: Shared Google auth (extracted from gcal_client)
├── google_client.py     # ✨ NEW: Base class for all Google API clients
└── gmail_client.py      # ✨ NEW: Gmail client implementation

tests/
├── __init__.py
├── conftest.py
├── test_cli.py
├── test_config.py
├── test_datetime_utils.py
├── test_env_config.py
├── test_errors.py
├── test_format.py
├── test_google_auth.py       # ✨ NEW: Tests for google_auth module
├── test_google_client.py      # ✨ NEW: Tests for base client
└── test_gmail_client.py       # ✨ NEW: Tests for Gmail client
```

**Structure Decision**:

- Flat single-project layout continues (no new top-level directories)
- Refactoring extracts 3 new modules: `google_auth.py`, `google_client.py`, `gmail_client.py`
- `GCalClient` refactored to use new base class (minimal changes to existing `gcal_client.py`)
- Config extended for Gmail settings (additions to `config.py`)
- CLI extended with Gmail commands (additions to `cli.py`)
- All existing module boundaries respected per Constitution Principle I

## Complexity Tracking

> **No Constitution violations identified.** All principles satisfied; no complexity exceptions needed.

## Phase 0: Research & Investigation

**Goal**: Resolve all technical unknowns and clarify design patterns before Phase 1.

### Research Tasks

1. **Google OAuth Scope Management Patterns**

   - **Question**: How should scopes be managed when users add Gmail to existing Calendar setup?
   - **Investigation**: Review google-auth-oauthlib documentation for incremental authorization support; test if adding scopes requires re-authentication or if refresh is sufficient
   - **Owner**: Implementation team
   - **Outcome**: Design for scope extension workflow in GoogleAuth module

2. **Token File Management for Multiple APIs**

   - **Question**: Can one token file contain credentials for multiple Google APIs (Calendar + Gmail)?
   - **Investigation**: Verify if google-auth library supports single token file with multiple scopes; confirm token refresh applies to all scopes
   - **Owner**: Implementation team
   - **Outcome**: Finalize token persistence strategy in GoogleAuth module

3. **Error Handling & Quota Management**

   - **Question**: How should rate limiting and quota errors be distinguished and handled?
   - **Investigation**: Review Gmail API error codes (rate limit 429, quota exceeded 403); compare with Calendar API patterns; design unified error categorization
   - **Owner**: Implementation team
   - **Outcome**: Error classification strategy for google_client.py base class

4. **Backward Compatibility Verification**

   - **Question**: What specific GCalClient behaviors must remain identical after refactoring?
   - **Investigation**: Review all tests in tests/test_cli.py and existing GCalClient usage; document expected behaviors
   - **Owner**: Implementation team
   - **Outcome**: Contract specification for GCalClient refactoring

5. **Base Class vs. Protocol Design Decision**
   - **Question**: Should we use inheritance (ABC) or Python protocol (structural typing) for GoogleAPIClient?
   - **Investigation**: Compare inheritance vs. protocol approaches for testability, type checking, and future extensibility
   - **Owner**: Design review (architecture decision)
   - **Outcome**: Finalized design choice documented in design.md

**Output**: `research.md` — all investigations documented with decisions and rationale

## Phase 1: Design & Contracts

**Goal**: Define data models, API contracts, and developer patterns.

### Deliverables

1. **data-model.md**

   - GoogleAuth entity: credentials, token, scopes, refresh strategy
   - GoogleAPIClient contract: initialization, service building, error handling, retry logic
   - GMailClient entity: message model, label support, filter capability
   - Config schema: Gmail-specific settings (labels, output format)

2. **contracts/**

   - `google_auth_contract.py` — Protocol/ABC for GoogleAuth interface
   - `google_client_contract.py` — Protocol/ABC for GoogleAPIClient base
   - `gmail_client_contract.py` — Protocol for GMailClient interface
   - `config_schema.json` — Extended configuration schema with Gmail settings

3. **quickstart.md**

   - How to add new Google API client using the pattern
   - Configuration setup guide for Gmail
   - CLI commands and usage examples
   - Troubleshooting guide

4. **Agent Context Update**
   - Run `.specify/scripts/bash/update-agent-context.sh copilot`
   - Update Copilot instructions with new module responsibilities
   - Document new patterns and contracts

**Completion Gate**: Constitution check re-run after design is finalized

## Phase 2: Task Planning (Not in this deliverable)

Detailed implementation tasks will be generated by `/speckit.tasks` command in Phase 2, organized by user story and dependency order.
